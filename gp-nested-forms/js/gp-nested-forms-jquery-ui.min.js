!function(a){window.GPNestedForms=function(e){var s=this;for(prop in e)e.hasOwnProperty(prop)&&(s[prop]=e[prop]);s.init=function(){if(s.initSession(),void 0!==window["GPNestedForms_{0}_{1}".format(s.formId,s.fieldId)]){var e=window["GPNestedForms_{0}_{1}".format(s.formId,s.fieldId)];s.entries=e.entries,gform.removeFilter("gform_calculation_formula",10,"gpnf_{0}_{1}".format(s.formId,s.fieldId)),s.viewModel=e.viewModel}s.parentFormContainer=a("#gform_wrapper_"+s.formId),s.fieldContainer=a("#field_"+s.formId+"_"+s.fieldId),s.modalElem=a(".gpnf-nested-form-"+s.formId+"-"+s.fieldId),s.editDialogElem=a(".gpnf-edit-form-"+s.formId+"-"+s.fieldId),s.formHtml=s.getFormHtml(),s.entriesInput=a("#input_"+s.formId+"_"+s.fieldId),s.scrollY=0,s.modalArgs=gform.applyFilters("gpnf_modal_args",{autoOpen:!1,modal:!0,width:s.modalWidth<a(document).width()?s.modalWidth:a(document).width()-40,height:s.modalHeight,title:s.modalTitle,closeText:"Close",buttons:{},position:s.getPosition(),dialogClass:s.modalClass,draggable:!1,resizable:!1,close:function(e,o){s.modalDialog.html(""),s.editDialog.html(""),a(".ui-widget-overlay").removeClass(s.modalClass),window.scroll(0,s.scrollY)},open:function(){s.modalHeaderColor&&(s.modalDialog.siblings(".ui-dialog-titlebar").css("background-color",s.modalHeaderColor),s.editDialog.siblings(".ui-dialog-titlebar").css("background-color",s.modalHeaderColor)),a(".ui-widget-overlay").addClass(s.modalClass),s.hasConditionalLogic?a(document).on("gform_post_conditional_logic",function(e,o){s.nestedFormId==o&&s.repositionModals()}):s.repositionModals()}},s.formId,s.fieldId,s),a.fn.button.noConflict&&(a.fn.bootstrapBtn=a.fn.button.noConflict()),s.modalDialog=s.modalElem.dialog(s.modalArgs),s.editDialog=s.editDialogElem.dialog(a.extend({},s.modalArgs,{title:s.editModalTitle})),s.isBound(s.fieldContainer[0])||(s.viewModel=new o(s.prepareEntriesForKnockout(s.entries),s),ko.applyBindings(s.viewModel,s.fieldContainer[0])),a(document).on("click","#field_"+s.formId+"_"+s.fieldId+" .gpnf-add-entry",function(e){e.preventDefault(),s.scrollY=window.scrollY?window.scrollY:window.pageYOffset,s.modalElem.html(s.formHtml),s.modalDialog.dialog("open"),s.initFormScripts(),s.modalElem.find('input[name="gpnf_nested_form_field_id"]').val(s.fieldId)}),a(document).bind("gpnf_post_render",function(e,o,n){var t=a("#gform_wrapper_"+o);o==s.nestedFormId&&0<t.length&&a(document).trigger("gform_post_render",[s.nestedFormId,n]),s.handleParentMergeTag(),s.repositionModals()}),a(window).resize(function(){s.repositionModals()}),gform.addFilter("gform_calculation_formula",s.parseCalcs,10,"gpnf_{0}_{1}".format(s.formId,s.fieldId)),s.runCalc(s.formId),s.parentFormContainer.data("GPNestedForms_"+s.fieldId,s),window["GPNestedForms_{0}_{1}".format(s.formId,s.fieldId)]=s},s.initSession=function(){a.post(s.ajaxUrl,s.sessionData,function(e){})},s.repositionModals=function(){var e=s.getPosition(s.modalDialog);e.dnr||s.modalDialog.dialog("option","position",e),(e=s.getPosition(s.editDialog)).dnr||s.editDialog.dialog("option","position",e)},s.getPosition=function(e){if(!e)return{my:"center",at:"center",of:window};var o=a(window).height(),n=e.parents(".ui-dialog").height(),t="center",i=window,r=!1;return o<=n?(t="center top",i=window,e.data("do-not-reposition")?r=!0:e.data("do-not-reposition",!0)):e.data("do-not-reposition",!1),{my:t,at:t,of:i,dnr:r}},s.isBound=function(e){return!!ko.dataFor(e)},s.prepareEntriesForKnockout=function(e){for(var o=0;o<e.length;o++)e[o]=s.prepareEntryForKnockout(e[o]);return e},s.prepareEntryForKnockout=function(e){var o=a.extend({},e);for(var n in o)if(e.hasOwnProperty(n)){var t=e[n];!1===t.label&&(t.label=""),e["f"+n]=t}return e},s.refreshMarkup=function(){a.post(s.ajaxUrl,{action:"gpnf_refresh_markup",nonce:GPNFData.nonces.refreshMarkup,gpnf_parent_form_id:s.formId,gpnf_nested_form_field_id:s.fieldId},function(e){s.formHtml=e})},s.editEntry=function(e,o){var n=new i(o,s.spinnerUrl,"");o.css({visibility:"hidden"}),a.post(s.ajaxUrl,{action:"gpnf_edit_entry",nonce:GPNFData.nonces.editEntry,gpnf_entry_id:e,gpnf_parent_form_id:s.formId,gpnf_nested_form_field_id:s.fieldId},function(e){n.destroy(),o.css({visibility:"visible"}),s.scrollY=window.scrollY?window.scrollY:window.pageYOffset,s.editDialog.html(e).dialog("open"),s.initFormScripts()})},s.deleteEntry=function(o,n){var t=new i(n,s.spinnerUrl,"");n.css({visibility:"hidden"}),a.post(s.ajaxUrl,{action:"gpnf_delete_entry",nonce:GPNFData.nonces.deleteEntry,gpnf_entry_id:o.id},function(e){t.destroy(),n.css({visibility:"visible"}),e?e.success?(s.viewModel.entries.remove(o),s.refreshMarkup()):console.log("Error:"+e.data):console.log("Error: no response.")})},s.getFormHtml=function(){var e=s.modalElem.data("formHtml");return e||(e=s.modalElem.html()),s.modalElem.data("formHtml",e),s.modalElem.html(""),e},s.handleParentMergeTag=function(){s.modalElem.find(":input").each(function(){var e=a(this),o=e.data("gpnf-value");if(e.data("gpnf-changed"))return!0;if(!o)return!0;var n=/{Parent:(\d+(\.\d+)?)}/gi.exec(o);if(!n)return!0;var t=n[1];if(isNaN(t))return!0;var i=s.parentFormContainer.find("#input_"+s.formId+"_"+t.split(".").join("_"));i.hasClass("gfield_radio")&&(i=i.find("input:checked"));var r=a(this).val(),d=gform.applyFilters("gpnf_parent_merge_tag_value",i.val(),t,s.formId,s);r!=d&&a(this).val(d).change(),a(this).on("change",function(){a(this).data("gpnf-changed",!0)})})},s.initFormScripts=function(e){window.gform.doAction("gpnf_init_nested_form",s.nestedFormId),a(document).trigger("gform_post_render",[s.nestedFormId,1]),window.gformInitDatepicker&&gformInitDatepicker(),s.handleParentMergeTag()},s.runCalc=function(){a(document).trigger("gform_post_conditional_logic",[s.formId,[],!1])},s.parseCalcs=function(l,e,o,n){var t=getMatchGroups(l,/{[^{]*?:([0-9]+):(sum|total|count)=?([0-9]*)}/i);return a.each(t,function(e,o){var n=o[0],t=o[1],i=o[2],r=o[3],d=0;if(t==s.fieldId){switch(i){case"sum":var a=0;s.viewModel.entries().forEach(function(e){var o=0;void 0!==e[r]&&(o=e[r].value?e[r].value:0),a+=parseFloat(o)}),d=a;break;case"total":a=0;s.viewModel.entries().forEach(function(e){a+=parseFloat(e.total)}),d=a;break;case"count":d=s.viewModel.entries().length}l=l.replace(n,d)}}),l},GPNestedForms.loadEntry=function(e){var o=a("#gform_wrapper_"+e.formId).data("GPNestedForms_"+e.fieldId);if(entry=o.prepareEntryForKnockout(e.fieldValues),entry.id=e.entryId,"edit"==e.mode){var n=a('table.gpnf-nested-entries [data-entryid="'+entry.id+'"]').index();o.viewModel.entries.remove(function(e){return e.id==entry.id}),o.viewModel.entries.splice(n,0,entry),o.editDialog.dialog("close")}else o.modalDialog.dialog("close"),o.viewModel.entries.push(entry),o.refreshMarkup()},s.init()};var o=function(e,n){var o=this;o.entries=ko.observableArray(e),o.entries.subscribe(function(){n.parentFormContainer.children("form").trigger("change")}),o.isMaxed=ko.computed(function(){var e=gform.applyFilters("gpnf_entry_limit_max",n.entryLimitMax,n.formId,n.fieldId,n);return""!==e&&o.entries().length>=e}),o.entryIds=ko.computed(function(){var n=[];return a.each(o.entries(),function(e,o){n.push(o.id)}),n},o),o.runCalc=ko.computed(function(){return n.runCalc(),o.entries().length},o),o.editEntry=function(e,o){n.editEntry(e.id,a(o.target))},o.deleteEntry=function(e,o){n.deleteEntry(e,a(o.target))}};function i(e,o,n){return o=void 0!==o&&o?o:gf_global.base_url+"/images/spinner.gif",n=void 0!==n?n:"",this.elem=e,this.image='<img class="gfspinner" src="'+o+'" style="'+n+'" />',this.init=function(){return this.spinner=jQuery(this.image),jQuery(this.elem).after(this.spinner),this},this.destroy=function(){jQuery(this.spinner).remove()},this.init()}window.gpnfEventHandler=function(e,n,t){if(void 0===window.gpnfEvents&&(window.gpnfEvents=[]),0==window.gpnfEvents.length){var o=a._data(document).events.gform_post_render;a.each(o,function(e,o){"gpnf"==o.namespace&&window.gpnfEvents.push(o.handler)}),a(document).off("gform_post_render.gpnf")}a.each(window.gpnfEvents,function(e,o){o(o,n,t)})}}(jQuery);
//# sourceMappingURL=gp-nested-forms-jquery-ui.js.map